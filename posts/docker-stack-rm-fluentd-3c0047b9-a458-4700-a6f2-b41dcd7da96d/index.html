<!doctype html><html><head><title>docker stack rm 在有 fluentd 的時候總有服務關不掉</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><meta property="og:title" content="docker stack rm 在有 fluentd 的時候總有服務關不掉"><meta property="og:description" content="最近把 fluentd 加入到 docker swarm 中當作 Log Driver 的時候，
移除 docker stack 時，關閉得比較慢的 service 有機會沒辦法完整移除。
此時 docker inspect ， docker rm 等指令都會卡住。
唯一的解法就是重啟 docker daemon。
猜測因為沒辦法保證 fluentd 在最後一個關閉導致出錯了。
移除 docker stack docker stack rm mystack 檢查 service 都移除掉了 docker service ls ID NAME MODE REPLICAS IMAGE PORTS 發現還有 container 沒有正常關閉，且永遠卡在這個狀態 docker stack ps mystack --no-trunc ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTS 5fllkwthpur60gzgeqq4cow48 i1i65yn2b35jqsfqk7gb9y7l8.1 my-clamav:2022-0406-145048 localhost.localdomain Remove Running about a minute ago 檢查系統的 Log，有出現如下訊息 (我是 CentOS)："><meta property="og:type" content="article"><meta property="og:url" content="https://krapshsa.github.io/posts/docker-stack-rm-fluentd-3c0047b9-a458-4700-a6f2-b41dcd7da96d/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-28T16:19:00+08:00"><meta property="article:modified_time" content="2022-07-28T16:19:00+08:00"><meta property="og:site_name" content="My Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="docker stack rm 在有 fluentd 的時候總有服務關不掉"><meta name=twitter:description content="最近把 fluentd 加入到 docker swarm 中當作 Log Driver 的時候，
移除 docker stack 時，關閉得比較慢的 service 有機會沒辦法完整移除。
此時 docker inspect ， docker rm 等指令都會卡住。
唯一的解法就是重啟 docker daemon。
猜測因為沒辦法保證 fluentd 在最後一個關閉導致出錯了。
移除 docker stack docker stack rm mystack 檢查 service 都移除掉了 docker service ls ID NAME MODE REPLICAS IMAGE PORTS 發現還有 container 沒有正常關閉，且永遠卡在這個狀態 docker stack ps mystack --no-trunc ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR PORTS 5fllkwthpur60gzgeqq4cow48 i1i65yn2b35jqsfqk7gb9y7l8.1 my-clamav:2022-0406-145048 localhost.localdomain Remove Running about a minute ago 檢查系統的 Log，有出現如下訊息 (我是 CentOS)："><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.c5d92f380bf10f6849c7ac487c7df2b22c081e0851e5339224f1ae29210b20d2.css integrity="sha256-xdkvOAvxD2hJx6xIfH3ysiwIHghR5TOSJPGuKSELINI=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.9f8d8c2df9285089d141edd4a50cb7506c7948e6ab79a29968dced1bd0ab7d22.css integrity="sha256-n42MLfkoUInRQe3UpQy3UGx5SOareaKZaNztG9CrfSI=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"your client id",clientSecret:"your client secret",repo:"repo name",owner:"user",admin:["user"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://krapshsa.github.io/><div class=nav-title>KRAPSHSA'S BLOG</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
© 2007 - 2022 krapshsa</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://krapshsa.github.io/>KRAPSHSA'S BLOG</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://krapshsa.github.io/><div class=single-column-header-title>KRAPSHSA'S BLOG</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>docker stack rm 在有 fluentd 的時候總有服務關不掉<div class=post-meta><time itemprop=datePublished>2022-07-28 16:19</time>
<i class=material-icons>label</i>
<a href=/tags/docker>docker</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><p>最近把 <code>fluentd</code> 加入到 docker swarm 中當作 Log Driver 的時候，</p><p>移除 docker stack 時，關閉得比較慢的 service 有機會沒辦法完整移除。</p><p>此時 <code>docker inspect</code> ， <code>docker rm</code> 等指令都會卡住。</p><p>唯一的解法就是重啟 docker daemon。</p><p>猜測因為沒辦法保證 <code>fluentd</code> 在最後一個關閉導致出錯了。</p><p></p><ol><li>移除 docker stack</li></ol><pre tabindex=0><code>docker stack rm mystack
</code></pre><ol start=2><li>檢查 service 都移除掉了</li></ol><pre tabindex=0><code>docker service ls
ID        NAME      MODE      REPLICAS   IMAGE     PORTS
</code></pre><ol start=3><li>發現還有 container 沒有正常關閉，且永遠卡在這個狀態</li></ol><pre tabindex=0><code>docker stack ps mystack --no-trunc
ID                          NAME                          IMAGE                        NODE                    DESIRED STATE   CURRENT STATE                ERROR     PORTS
5fllkwthpur60gzgeqq4cow48   i1i65yn2b35jqsfqk7gb9y7l8.1   my-clamav:2022-0406-145048   localhost.localdomain   Remove          Running about a minute ago
</code></pre><p></p><p>檢查系統的 Log，有出現如下訊息 (我是 CentOS)：</p><pre tabindex=0><code>sudo cat /var/log/messages | grep 3c902d2962f7
Jul 28 10:48:49 localhost dockerd[1265564]: time=&#34;2022-07-28T10:48:49.917640954+08:00&#34; level=info msg=&#34;Configured log driver does not support reads, enabling local file cache for container logs&#34; container=3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b driver=fluentd
Jul 28 10:48:49 localhost containerd[1161]: time=&#34;2022-07-28T10:48:49.936470840+08:00&#34; level=info msg=&#34;starting signal loop&#34; namespace=moby path=/run/containerd/io.containerd.runtime.v2.task/moby/3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b pid=1269465 runtime=io.containerd.runc.v2
Jul 28 10:53:00 localhost dockerd[1265564]: time=&#34;2022-07-28T10:53:00.719182463+08:00&#34; level=info msg=&#34;ignoring event&#34; container=3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b module=libcontainerd namespace=moby topic=/tasks/delete type=&#34;*events.TaskDelete&#34;
Jul 28 10:53:00 localhost containerd[1161]: time=&#34;2022-07-28T10:53:00.719579189+08:00&#34; level=info msg=&#34;shim disconnected&#34; id=3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b
Jul 28 10:53:00 localhost containerd[1161]: time=&#34;2022-07-28T10:53:00.719667935+08:00&#34; level=warning msg=&#34;cleaning up after shim disconnected&#34; id=3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b namespace=moby
Jul 28 10:53:07 localhost dockerd[1265564]: time=&#34;2022-07-28T10:53:07.730207608+08:00&#34; level=info msg=&#34;Container failed to exit within 10s of signal 15 - using the force&#34; container=3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b
Jul 28 10:57:07 localhost dockerd[1271313]: time=&#34;2022-07-28T10:57:07.971173522+08:00&#34; level=info msg=&#34;Removing stale sandbox c540d42e6cba844695f8cb780f5c28a82a59500207ace2b6526d11eca5b54600 (3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b)&#34;
Jul 28 11:12:19 localhost dockerd[1271313]: time=&#34;2022-07-28T11:12:19.902248293+08:00&#34; level=error msg=&#34;Error getting service 3c902d2962f7: service 3c902d2962f7 not found&#34;
Jul 28 11:12:19 localhost dockerd[1271313]: time=&#34;2022-07-28T11:12:19.905022331+08:00&#34; level=error msg=&#34;Error getting task 3c902d2962f7: task 3c902d2962f7 not found&#34;
Jul 28 11:12:19 localhost dockerd[1271313]: time=&#34;2022-07-28T11:12:19.906474336+08:00&#34; level=error msg=&#34;Error getting node 3c902d2962f7: node 3c902d2962f7 not found&#34;
</code></pre><p></p><p>一開始懷疑是沒有辦法關掉 process，可能在卡在寫 Log 了。
照著這個思路，先去查詢查詢 container 相對應的 pid：</p><pre tabindex=0><code>docker inspect -f &#39;{{.State.Pid}}&#39; 3c902d2962f7
1269485
</code></pre><pre tabindex=0><code>sudo pstree -a -p

...

|-containerd-shim,1269465 -namespace moby -id 3c902d2962f7fb6af8ce5a16a965bd2707383dbb18fed9b6942e1687f6419c4b -address/run/
|   |-docker-init,1269485 -- /bootstrap.sh
|   |   |-clamd,1269536 -c /etc/clamav/clam.conf
|   |   |   `-{clamd},1269731
|   |   |-freshclam,1269560 -d -c 6
|   |   |   `-{freshclam},1269732
|   |   `-gunicorn,1269558 /usr/bin/gunicorn --workers=2 --threads=2 --bind 0.0.0.0:8000 --daemon wsgi:app
|   |       |-gunicorn,1269561 /usr/bin/gunicorn --workers=2 --threads=2 --bind 0.0.0.0:8000 --daemon wsgi:app
|   |       `-gunicorn,1269562 /usr/bin/gunicorn --workers=2 --threads=2 --bind 0.0.0.0:8000 --daemon wsgi:app

...
</code></pre><p>接著移除掉整個 stack。</p><p>但是發現儘管 docker ps 看到 container 還在，但 pid 已經找不到了。</p><p></p><p>看起來這個 container 沒有施力點，只好試試看手動調整關閉 Service 的順序</p><p>最後寫成腳本：</p><pre tabindex=0><code>function get_services() {
  services=$(docker service ls --format &#34;{{.Name}}&#34; | sed -E &#39;s/mystack_//&#39;)
  echo &#34;$services&#34;
}

function down() {
  stack_prefix=&#34;mystack_&#34;
  last_service=&#34;fluentd&#34;
  services=$(get_services)
  services=${services[*]/$last_service}

  for service in $services
  do
    docker service rm &#34;$stack_prefix$service&#34; &gt; /dev/null
  done

  # wait for all containers removed.
  for i in {1..60}
  do
    docker ps -a | grep -v &#34;$stack_prefix$last_service&#34; | grep -q &#34;$stack_prefix&#34;
    if [ $? -eq 1 ]; then
      docker service rm &#34;$stack_prefix$last_service&#34; &gt; /dev/null
      break
    fi
    sleep 1
  done

  if [[ &#34;60&#34; -eq &#34;$i&#34; ]]; then
    exit 1
  fi

  for i in {1..60}
  do
    docker ps -a | grep -q &#34;$stack_prefix&#34;
    if [ $? -eq 1 ]; then
      break
    fi
    sleep 1
  done

  if [[ &#34;60&#34; -eq &#34;$i&#34; ]]; then
    exit 1
  fi
}

down
</code></pre><p></p><hr width=100% id=EOF><p style=color:#777>Last modified on 2022-07-28</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/windows-unix-cygwin-mingw-msys-05707f1a-cacd-4484-9457-7aa26c7cace8/>Next<br>Windows 上的類 Unix 環境 - Cygwin、MinGW、MSYS</a>
<a class=older-posts href=/posts/owncloud-mariadb-mysqldump-84758a8c-6502-4c2d-b878-3a97ea0e36a7/>Previous<br>OwnCloud MariaDB mysqldump 失敗</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
© 2007 - 2022 krapshsa</div></div><script src=/js/journal.js></script></body></html>